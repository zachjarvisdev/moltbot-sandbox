===
dump gateway logs for debugging
===
WORKER_URL=$(cat "$CCTR_FIXTURE_DIR/worker-url.txt" 2>/dev/null || echo "")
if [ -n "$WORKER_URL" ]; then
    PROCS=$(./curl-auth -s "$WORKER_URL/debug/processes" 2>/dev/null || echo "")
    PROC_ID=$(echo "$PROCS" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
    if [ -n "$PROC_ID" ]; then
        echo "=== Gateway process logs ($PROC_ID) ==="
        ./curl-auth -s "$WORKER_URL/debug/logs?id=$PROC_ID" 2>/dev/null | python3 -c "
import sys, json
try:
    d = json.load(sys.stdin)
    if d.get('stdout'): print('STDOUT:', d['stdout'][-3000:])
    if d.get('stderr'): print('STDERR:', d['stderr'][-3000:])
except: print('Failed to parse logs')
" || echo "Failed to fetch logs"
    else
        echo "No gateway process found"
        echo "Processes: $PROCS"
    fi
else
    echo "No worker URL found"
fi
echo "dump complete"
---
{{ output }}
---
where
* output contains "dump complete"

===
stop video recording
===
./pw --session=moltworker-e2e video-stop || true
---
{{ output }}
---
where
* output contains "Video" or output contains "Error" or output contains "No"

===
save video recording
===
mkdir -p /tmp/moltworker-e2e-videos
datetime=$(date +%Y%m%d-%H%M%S)
for f in ./.playwright-cli/*.webm; do
  if [ -f "$f" ]; then
    cp "$f" "/tmp/moltworker-e2e-videos/${datetime}.webm"
    echo "video saved to /tmp/moltworker-e2e-videos/${datetime}.webm"
  fi
done
# Always succeed even if no video
echo "video cleanup complete"
---
{{ output }}
---
where
* output contains "video"

===
stop playwright browser
===
./stop-browser || true
echo "browser stopped"
---
{{ output }}
---
where
* output contains "stopped"

===
stop moltworker server and destroy cloud resources
===
# This deletes the worker AND destroys terraform resources (Access app, service token, R2 bucket)
./stop-server
---
{{ s }}
---
where
* strip(s) endswith "stopped"
